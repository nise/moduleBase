var 
	mongo = require('mongodb'),
	users = require('../routes/users.js'),
	fs = require('node-fs'),
	csv = require('csv');
 
var Server = mongo.Server,
    Db = mongo.Db,
    BSON = mongo.BSONPure;
 
var server = new Server('localhost', 27017, {auto_reconnect: true});
db = new Db('winedb', server,  {safe:true});
exports.db = db;



db.open(function(err, db) { 

  if(err) {
  		console.log(err);
      // hier stand der code für leere DBs
      
  }else{

    db.collection('script', {safe:true}, function(err, collection) {        
        console.log("The 'script' collection doesn't exist. Creating it with sample data...");
        //populateScript();
        
    });
    db.collection('users', {safe:true}, function(err, collection) {        
        console.log("The 'users' collection doesn't exist. Creating it with sample data...");
        //users.loadUserTable();
    });
    db.collection('groups', {safe:true}, function(err, collection) {        
        console.log("The 'groups' collection doesn't exist. Creating it with sample data...");
        //loadGroupTable();
    });
    /**/db.collection('videos', {safe:true}, function(err, collection) {        
        console.log("The 'videos' collection doesn't exist. Creating it with sample data...");
        if(!err){
        	//loadVideoTable();
        }
    });
    db.collection('messages', {safe:true}, function(err, collection) {        
        console.log("The 'messages' collection doesn't exist. Creating it with sample data...");
        if(!err){
         	//populateMessages();
        } 
    });
  }  
});
 
 
 



exports.updateUsers = function(req, res) {
    var id = req.params.id;
    var user = req.body;
    console.log('Updating users: ' + id);
    console.log(JSON.stringify(user));
    db.collection('users', function(err, collection) {
        collection.update({'_id':new BSON.ObjectID(id)}, {$set:{trace:user.data}}, {safe:true}, function(err, result) {
            if (err) {
                console.log('Error updating user: ' + err);
                res.send({'error':'An error has occurred'});
            } else {
                console.log('' + result + ' document(s) updated');
                res.send(user);
            }
        });
    });
}  
 
 
 
 
 
 
/* 
 
 
 
exports.findById = function(req, res) {
    var id = req.params.id;
    console.log('Retrieving wine: ' + id);
    db.collection('wines', function(err, collection) {
        collection.findOne({'_id':new BSON.ObjectID(id)}, function(err, item) {
            res.send(item);
        });
    });
};
 
exports.findAll = function(req, res) {
    db.collection('wines', function(err, collection) {
        collection.find().toArray(function(err, items) {
        console.log("wines?");
            //res.send(items);
            //res.send(JSON.stringify(items));
            
            res.type('application/json');
    				res.jsonp(items);  //items is the object
        });
    });
};








exports.getVideos = function(req, res) {
    db.collection('videos', function(err, collection) {
        collection.find().toArray(function(err, items) {
            res.type('application/json');
    				res.jsonp(items);  //items is the object
        });
    });
};

exports.getRelatedVideos = function(req, res) {
		var video_list = []
		var arr = (req.params.id).split(',')
    for(var i = 0, len = arr.length; i < len; i++){
    	video_list.push({id:arr[i]});
    }
    db.collection('videos', function(err, collection) {
        collection.find({ $or: video_list }).toArray(function(err, items) {
            res.type('application/json');
    				res.jsonp(items);  //items is the object
        });
    });
};

exports.getVideoById = function(req, res) {
    var id = req.params.id;
    console.log('Retrieving video: ' + id);
    db.collection('videos', function(err, collection) {
			//        collection.findOne({'_id':new BSON.ObjectID(id)}, function(err, item) {
			collection.findOne({'id':id}, function(err, item) {
      	res.send([item]);
     	});
    });
};


exports.updateVideoComments = function(req, res) {
    var id = req.params.id;
    var video = req.body;
    console.log('Updating video: ' + id);
    console.log(JSON.stringify(video));
    db.collection('videos', function(err, collection) {
        collection.update({'_id':new BSON.ObjectID(id)}, {$set:{comments:video.data}}, {safe:true}, function(err, result) {
            if (err) {
                console.log('Error updating video comments: ' + err);
                res.send({'error':'An error has occurred'});
            } else {
                console.log('' + result + ' document(s) updated');
                res.send(video);
            }
        });
    });
}


exports.updateVideoTags = function(req, res) {
    var id = req.params.id;
    var video = req.body;
    console.log('Updating video: ' + id);
    console.log(JSON.stringify(video));
    db.collection('videos', function(err, collection) {
        collection.update({'_id':new BSON.ObjectID(id)}, {$set:{tags:video.data}}, {safe:true}, function(err, result) {
            if (err) {
                console.log('Error updating video tags: ' + err);
                res.send({'error':'An error has occurred'});
            } else {
                console.log('' + result + ' document(s) updated');
                res.send(video);
            }
        });
    });
}
 



exports.updateVideoAssessment = function(req, res) {
    var id = req.params.id;
    var video = req.body;
    console.log('Updating video: ' + id);
    console.log(JSON.stringify(video));
    db.collection('videos', function(err, collection) {
        collection.update({'_id':new BSON.ObjectID(id)}, {$set:{assessment:video.data}}, {safe:true}, function(err, result) {
            if (err) {
                console.log('Error updating assessment: ' + err);
                res.send({'error':'An error has occurred'});
            } else {
                console.log('' + result + ' document(s) updated');
                res.send(video);
            }
        });
    });
}



exports.getMessages = function(req, res) {
    db.collection('messages', function(err, collection) {
        collection.find().toArray(function(err, items) {
            res.type('application/json');
    				res.jsonp(items);  //items is the object
        });
    });
};

exports.addMessage = function(req, res) {
    var message = req.body;
    console.log('Adding message: ' + JSON.stringify(message));
    db.collection('messages', function(err, collection) {
        collection.insert(message.data, {safe:true}, function(err, result) {
            if (err) {
                res.send({'error':'An error has occurred'});
            } else {
                console.log('Success: ' + JSON.stringify(result[0]));
                res.send(result[0]);
            }
        });
    });
} 

exports.addVideo = function(req, res) {
    var video = req.body;
    console.log('Adding message: ' + JSON.stringify(video));
    db.collection('videos', function(err, collection) {
        collection.insert(video.data, {safe:true}, function(err, result) {
            if (err) {
                res.send({'error':'An error has occurred'});
            } else {
                console.log('Success: ' + JSON.stringify(result[0]));
                res.send('done');
            }
        });
    });
}

 */
 
 
 
/*--------------------------------------------------------------------------------------------------------------------*/
 
 
// VI-SETTING
/*
1. get Widgets  => wird vom client gemeldet
2. load widgets options by type => wird vom client gefordert
3. render Form for each widget by its options 
-- woher kommen die label der Felder?
-- woher kommen die Hilfetexte der felder?
-- welche felder müssen ausgefült werden
4. make options accessible for client: GET /widget-options/[:widget]

*/ 
 
 



/***************************************************/
/* VIDEO MGMT 

	var videos = [];

/* Load user data from csv file. Insert data into database 
loadVideoTable = function(){
	
	// read file
	fs.readFile(__dirname+'/../data/videos.csv', function read(err, data) { 
		csv().from.string(data, {comment: '#'} )
			.to.array( function(data){
				//console.log(data);
				// groups = [];
				var fileformat = 'webm';
				//var remote_server = 'http://141.46.8.101/beta/scm-lab2/';
				//var remote_server = 'http://localhost:3000/';
				// define group for each line
				for(var i = 1; i < data.length; i++){   
					//console.log(data[i]);
					var v = {
						id : data[i][0],
						metadata:[{
							author: data[i][1],
							institution: data[i][2],
							title: data[i][3],
							category: data[i][4],
							abstract: data[i][5],
							length: data[i][6],
							date: "2013/12/04",
							weight: 0,
							source: data[i][8],
						}],
						progress : "",
						video: '/vi-lab/videos/'+data[i][7]+'.'+fileformat, //"http://127.0.0.1/video_warehouse_management_systeme.webm",
						thumbnail: 'img/video-icons/'+data[i][7]+'.png',
						tags:[],
						comments:[],
						assessment:[],
						toc:[],
						links:[]
					};
					//console.log(JSON.stringify(v));
					//console.log('..................');
					videos.push(v);
					
				}// end for
				// insert into database   
				db.collection('videos', function(err, collection) {
				    collection.remove();
				    console.log("Removed videos");
				});
				db.collection('videos', function(err, collection) {
				    collection.insert(videos, {safe:true}, function(err, result) {});
				    console.log("Added videos");
				});	
			});// end read
	});// end csv
};
	var videosxxx = [
	
			{
				"id" : "5294bc22985254e831000002",
				"metadata":[{
					"author": "Prof. Peter Greistorfer (Universität Graz)",
					"institution": "Universität Graz, Österreich",
					"title": "Grundlagen der Produktion und Logistik (A)",
					"category": "Grundlagen",
					"abstract": "--",
					"length": 42.53,
					"date": "2011/07/01",
					"weight": 1
				}],
				"progress" : "",
				"video": "http://127.0.0.1/video2.webm",
				"comments":[],
				"tags": [
					{"tagname":"drought","occ":[10]},
					{"tagname":"El Nino","occ":[20]},
					{"tagname":"La Nina","occ":[30]},
					{"tagname":"unguaged catchments","occ":[40]},
					{"tagname":"copula modelling","occ":[50]},
					{"tagname":"dendrohydrology","occ":[60]},
					{"tagname":"Ethiopia","occ":[10]}
				],
				"comments": [
					{"comment":"hallo welt", "start":"65","author":"thum.daniel","author":"1", "date":"2013-01-03 13:01:46"}			
				],
				"assessment":[],
				"toc": [
    		  {"label":"Outline","duration":1,"start":"64.200","author":"1", "date":"2013-01-03 13:01:46"},
    		  {"label":"1. Introduction","duration":1,"start":"98.640","author":"1", "date":"2013-01-03 13:01:46"},
    		  {"label":"2. Objectives","duration":1,"start":"195.960","author":"1", "date":"2013-01-03 13:01:46"},
    		  {"label":"3. Study Area","duration":1,"start":"324.080","author":"1", "date":"2013-01-03 13:01:46"},
    		  {"label":"4. Data and Methodology","duration":1,"start":"490.800","author":"1", "date":"2013-01-03 13:01:46"},
    		  {"label":"5. Results","duration":1,"start":"1329.800","author":"1", "date":"2013-01-03 13:01:46"},
    		  {"label":"6. Conclusions","duration":1,"start":"1730.160","author":"1", "date":"2013-01-03 13:01:46"},
    		  {"label":"References","duration":1,"start":"1805.000","author":"1", "date":"2013-01-03 13:01:46"}
				],
				"links":[
					{"type":"cycle","x":50,"y":88,"duration":"15.5","start":"00:01:21","id":"Hydrological droughts","seek":"00:19:36","duration2":"00:44:55","target":"cullmann","author":"1", "date":"2013-01-03 13:01:46"},
					{"type":"cycle","x":50,"y":88,"duration":"10","start":"00:03:21","id":"Ungauged catchment","seek":"00:49:29","duration2":"00:51:10","target":"saliha2","author":"1", "date":"2013-01-03 13:01:46"}
				]
			},
			{
				"id" : "2",
				"metadata":[{
					"author": "Prof. Dr. Eric Demaine (MIT)",
					"institution": "MIT, USA",
					"title": "Dynamic Graphs",
					"category": "Waste Water",
					"abstract": "This lecture iM.",
					"length": 80,
					"date": "2012/10/01",
					"weight": 5
				}],
				"progress" : "",
				"video": "http://127.0.0.1/video_graphen.webm",
				"tags":[{"tagname":"Ethiopia","occ":[0]}],
				"comments":[
					{"comment":"hallo welt", "start":"65","author":"thum.daniel","author":"1", "date":"2013-01-03 13:01:46"}			
				],
				"assessment":[ {
        "title": "%7B%22question%22%3A%22hello%22%2C%22answ%22%3A%5B%7B%22id%22%3A%22answ96%22%2C%22answ%22%3A%22e%22%2C%22questiontype%22%3A%22mc%22%7D%2C%7B%22id%22%3A%22answ62%22%2C%22answ%22%3A%22eeee%22%2C%22questiontype%22%3A%22mc%22%7D%5D%2C%22correct%22%3A%5B%5D%7D",
        "start": "2.54128",
        "author": "1",
        "date": "1386149521026"
      }],
				"toc":[],
				"links":[]
			},
			{
				"id" : "3",
				"metadata":[{
					"author": "Moritz Roidl (TU Darmstadt)",
					"institution": "Technische Universität Darmstadt",
					"title": "Warehouse-Management-Systeme",
					"category": "SCM",
					"abstract": "This lecture iM.",
					"length": 80,
					"date": "2012/10/01",
					"weight": 5
				}],
				"progress" : "",
				"video": "http://127.0.0.1/video_warehouse_management_systeme.webm",
				"tags":[],
				"comments":[
				{"comment":"hallo welt", "start":"65","author":"thum.daniel","author":"1", "date":"2013-01-03 13:01:46"}			
				],
				"assessment":[],
				"toc":[],
				"links":[]
			}
		];
		
*/



/* 
* message types: // test result / feedback / mail
**/
var populateMessages = function(){
   
	var messages = [
    {
    	from : '1',
    	to : 'mix',
    	date : '1385849659158',
    	type : 'mail',
    	read : false, 
    	replied: false,
    	title : 'hello world',
    	content : 'nice world here'
    }
   ];
    	
	db.collection('messages', function(err, collection) {
      collection.remove();
      console.log("Removed messages");
  });
  db.collection('messages', function(err, collection) {
      collection.insert(messages, {safe:true}, function(err, result) {});
      console.log("Added messages");
  });
};  





