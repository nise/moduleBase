
<% layout( 'm_layout' ) -%>

<div class="jumbotron">
	<div class="container">
  <h2>Modulsuche</h2>
  <h3 data-i18n="app.name"></h3>
  
  <div class="search-fields">
		<div id="row-0" class="search-field-row">
			<select id="row-0-operator" class="select select-operator">
				<option>AND</option>
				<option>OR</option>
				<option>NOT</option>
			</select>
			<select id="row-0-field" class="select select-field">
				<option data-multi="true" data-key="tags" >Schlüsselwörter</option><!-- multi -->
				<option data-multi="false" data-key="modulnr">Modulnummer</option>
				<option data-multi="false" data-key="title">Modultitel</option>
				<option data-multi="true" data-key="courses" >Studiengang</option><!-- multi -->
				<option data-multi="true" data-key="type" >Type</option><!-- multi -->
				<option data-multi="true" data-key="university" >Hochschule</option><!-- multi -->
				<option data-multi="true" data-key="language" >Sprache</option><!-- multi -->
				<option data-multi="true" data-key="sws" >Lehrform</option><!-- multi -->
				<option data-multi="false" data-key="sws">SWS</option>
				<option data-multi="false" data-key="sws">SWS Selbststudium</option>
				<option data-multi="false" data-key="ects">ECTS</option>
				<option data-multi="true" data-key="pvl" >Prüfungsvorleistung</option><!-- multi -->
				<option data-multi="true" data-key="pl" >Prüfungsleistung</option><!-- multi -->
				<option data-multi="true" data-key="semester" >WS/SS</option><!-- multi -->
				<option data-multi="false" data-key="xxx">Modulverantwortlicher</option>
				<option data-multi="false" data-key="xxx">Verantw. Struktureinheit</option>
				<option data-multi="false" data-key="xxx">Weitere Lehrende</option>
				<option data-multi="false" data-key="xxx">Bemerkungen</option>		
			</select>
			<span id="row-0-input" class="select-input">
				<input id="fulltext-search" class="mbase-search-container" type="text">
			</span>	
		</div>
	</div>	
	
	<span id="add-field-row" class="glyphicon glyphicon-plus"></span>	
	<div class="buttons">
     <button id="submitfulltextsearch" type="submit">suchen</button>  
  </div>

</div>

<div class="container">
	<h3>Suchergebnisse</h3>
	<table id="table1"></table>
</div>

<script> 
$(document).ready(function() {
	

	$('#add-field-row').click(function(){ 
		var row = $('.search-fields').find('.search-field-row').first().clone();
		var id = Math.floor(Math.random()*1000);
		row.attr('id', 'row-'+ id);
		row.find('.select-operator').attr('id', 'row-'+ id + '-operator');
		row.find('.select-field').attr('id', 'row-'+ id + '-field');
		row.find('.select-input').attr('id', 'row-'+ id + '-input');
		$('.search-fields').append( row );
	});


  // get field schemas
  $.get('/json/modules/field-schema', function(data){
  	field_schemas = data;
  	  $('.select-field').change(function(e){ alert('#' + $(this).attr('id') + '-input')
				setDataSchema( {
						id : $(this).find(':selected').attr('id'), 
						key: $(this).find(':selected').data('key'), 
						multiselect: $(this).find(':selected').data('multi'),
						selector : '#' + $(this).attr('id').replace('-field','') + '-input'
				} );
			});
  });
  
  
  
});


var field_schemas = {};

/*
 *
 */
 function setDataSchema ( obj ){ 
 	if( obj.multiselect ){
 		// simple
 		var select = $('<select></select>')
 			.attr('id',"field-search" + obj.selector)
 			.addClass('multiple-select-'+ obj.key +' mbase-search-container')
 			.attr('multiple',"multiple")
 			;
 		if( field_schemas[ obj.key ] === undefined ){
 			alert('empty_'+obj.key)
 			
 		// init tags	
 		}else if( obj.key === 'tags'){ //alert(JSON.stringify())
 			for(var group in field_schemas[ obj.key ]){
				if( field_schemas[ obj.key ].hasOwnProperty(group) ){
					var gr = $('<optgroup></optgroup>')
						.attr('label', group)
						.appendTo( select );
						;	
					for(var i = 0; i < field_schemas[ obj.key ][group].length; i++){
						$('<option>')
							.attr('value', field_schemas[ obj.key ][group][i] )
							.text( field_schemas[ obj.key ][group][i] )
							.appendTo( gr )
							;
					}		
				}
			}// end for
			$( obj.selector ).html( select );
			$('.multiple-select-'+ obj.key ).select2();
			
		// init other multi-select fields	
 		}else{	
	 		for(var i = 0; i < field_schemas[ obj.key ].length; i++){
				$('<option>')
					.attr('value', field_schemas[ obj.key ][i] )
					.text(  field_schemas[ obj.key ][i] )
					.appendTo( select )
					;
			} 
			$( obj.selector ).html( select );
		}	 
  	// activate multi select
  	$('.multiple-select-'+ obj.key ).select2();
  	
  	// init default input
 	}else{
 		$( obj.selector ).html( '<input id="fulltext-search" class="mbase-search-container" type="text">' );
 	}
 }



/*
 *
 */
function showSearchResults( data ){
$('#table1').bootstrapTable({
    //url: '/data/json/modules',
    data : data,
    onLoadError : function(e){ alert(JSON.stringify(e)); },
    //    onLoadSuccess : function(e){ alert(JSON.stringify(e)); },
    //height:'500',
    showColumns : true,
    checkboxHeader : true,
   // cardView:true, // mobile view
    showExport:true,
    exportDataType:'selected',
    exportOptions: {
    	consoleLog: false,
			csvEnclosure: '"',
			csvSeparator: ',',
			csvUseBOM: true,
			displayTableName: false,
			escape: false,
			excelstyles: [ 'css','properties','to','export','to','excel' ],
			fileName: 'tableExport',
			htmlContent: false,
			ignoreColumn: [],
			ignoreRow: [],
			onCellData: null,
			outputMode: 'file',
			tbodySelector: 'tr',
			theadSelector: 'tr',
			tableName: 'myTableName',
			type: 'csv',
			worksheetName: 'xlsWorksheetName'
    },
    // search
    search: true,
    strictSearch: true,
    trimOnSearch:true,
    
    // details
    detailView : true,
    detailFormatter : function(index, row) {
			return '<a href="/modules/view/' + row._id + '">Detailansicht</a> | <a href="/data/pdf/' + row._id + '">Modulbeschreibung (PDF)</a> | <a href="/modules/edit/' + row._id + '">bearbeiten</a>'//''+index+'__'+row._id;
		},
		//onClickRow : function(row, el){ alert(row._id); },
    onClickCell : function(field, value, row, el){ if(field==='modultitel'){ 
    	alert(row._id);
    } },
    columns: [
		  { field: 'modultitel', title: 'Modulbezeichnung', sortable : true, order: 'asc',searchable : true }, 
		 	{ field: 'modulnr1', title: 'Modulnummer', visible:false, sortable : true, order: 'asc',searchable : true }, 
		  { field: 'modulnr2', title: 'Modulnummer 2', visible:false, sortable : true, order: 'asc',searchable : true }, 
		  { field: 'modulnr3', title: 'Modulnummer 3', visible:false, sortable : true, order: 'asc',searchable : true }, 
		  { field: 'courses', title: 'Studiengang',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'type', title: 'BA/MA',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'university', title: 'Hochschule',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'language', title: 'Sprache',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'sws_total', title: 'SWS',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'workload', title: 'Workload',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'workload_self', title: 'Workload Selbst',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'ects', title: 'ECTS',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'summer_winter', title: 'Semester',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'modulverantwortlicher', title: 'Modulverantwortliche/r',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'mail', title: 'E-Mail',sortable : true, visible:false, order: 'asc',searchable : true }, 
		  { field: 'lecturers', title: 'Weitere Dozenten',sortable : true, visible:false, order: 'asc',searchable : true }, 
		  { field: 'remarks', title: 'Hinweise',sortable : true, order: 'asc',visible:false, searchable : true }, 
		  { field: 'updated_at', title: 'Letzte Änderung',sortable : true, visible:false, order: 'asc',searchable : true }
    ]
	});
}

</script>


