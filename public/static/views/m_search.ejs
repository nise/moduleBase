
<% layout( 'm_layout' ) -%>

<div class="jumbotron">
	<div class="container">
  <h2>Modulsuche</h2>
  <h3 data-i18n="app.name"></h3>
  
  <div class="search-fields">
		<div id="row-0" class="search-field-row">
			<select id="row-0-operator" class="select select-operator">
				<option>AND</option>
				<option>OR</option>
				<option>NOT</option>
			</select>
			<select id="row-0-field" class="select select-field">
				<option selected disabled hidden value='' data-key=""></option>
				<option data-multi="true" data-key="tags" >Schlüsselwörter</option><!-- multi -->
				<option data-multi="false" data-key="modulnr">Modulnummer</option>
				<option data-multi="false" data-key="title">Modultitel</option>
				<option data-multi="true" data-key="courses" >Studiengang</option><!-- multi -->
				<option data-multi="true" data-key="type" >Type</option><!-- multi -->
				<option data-multi="true" data-key="university" >Hochschule</option><!-- multi -->
				<option data-multi="true" data-key="language" >Sprache</option><!-- multi -->
				<option data-multi="true" data-key="sws" >Lehrform</option><!-- multi -->
				<option data-multi="false" data-key="sws">SWS</option>
				<option data-multi="false" data-key="sws">SWS Selbststudium</option>
				<option data-multi="false" data-key="ects">ECTS</option>
				<option data-multi="true" data-key="pvl" >Prüfungsvorleistung</option><!-- multi -->
				<option data-multi="true" data-key="pl" >Prüfungsleistung</option><!-- multi -->
				<option data-multi="true" data-key="semester" >WS/SS</option><!-- multi -->
				<option data-multi="false" data-key="xxx">Modulverantwortlicher</option>
				<option data-multi="false" data-key="xxx">Verantw. Struktureinheit</option>
				<option data-multi="false" data-key="xxx">Weitere Lehrende</option>
				<option data-multi="false" data-key="xxx">Bemerkungen</option>		
			</select>
			<span id="row-0-input" class="select-input">
				<input id="fulltext-search" class="mbase-search-container" type="text">
			</span>	
			<span id="row-0-remove" class="remove glyphicon glyphicon-remove mb-btn"></span>
		</div>	 
	</div>	
	
	<div id="add-field-row" class="mb-btn"><span class="glyphicon glyphicon-plus"></span> Suchfeld hinzufügen</div>	
	<div class="buttons">
     <button id="submitsearch" class="btn-default btn" type="submit">Suchen</button>  
  </div>

</div>

<div class="container">
	<h3 hidden >Suchergebnisse</h3>
	<table id="table1"></table>
</div>

<script> 

var field_schemas = {};

$(document).ready(function() {
	

	$('#add-field-row').click(function(){ 
		addFieldRow( this );	
	});
	
	$('.remove').click(function(){
		removeFieldRow( this );
	});
	
	$('#submitsearch').click(function(){
		submitSearch();
	});
	
	$('.search-fields').find('.remove').hide();

  // get field schemas
  $.get('/json/modules/field-schema', function(data){
  	field_schemas = data;
  	  $('#row-0 > .select-field').change(function(e){ 
				var obj = {
						id : $(this).find(':selected').attr('id'), 
						key: $(this).find(':selected').data('key'), 
						multiselect: $(this).find(':selected').data('multi'),
						selector : '#' + $(this).attr('id').replace('-field','') + '-input'
				}; 
				setDataSchema( obj );
			});
  });
  
  
  
});


/*
 * Adds a new row for selecting a data field.
 */
 function addFieldRow( row ){
 		var row = $('.search-fields').find('.search-field-row').first().clone();
		var id = Math.floor(Math.random()*1000);
		row.attr('id', 'row-'+ id);
		row.find('.select-operator').attr('id', 'row-'+ id + '-operator');
		row.find('.select-field').attr('id', 'row-'+ id + '-field');
		row.find('.remove').attr('id', 'row-'+ id + '-remove');
		row.find('.select-input').empty().attr('id', 'row-'+ id + '-input');
		$('.search-fields').append( row );
		
		row.find('.select-field').change(function(e){  
				var obj = {
						id : $(this).find(':selected').attr('id'), 
						key: $(this).find(':selected').data('key'), 
						multiselect: $(this).find(':selected').data('multi'),
						selector : '#' + $(this).attr('id').replace('-field','') + '-input'
				}; 
				setDataSchema( obj );
			});
			
		row.find('.remove').click(function(){
			removeFieldRow( this );
		});
		
		$('.search-fields').find('.remove').show();
 }


/*
 * Removes a row of a data field.
 */
 function removeFieldRow( row ){
 		
		$( row ).parent().remove();
		if( $('.search-fields').find('.remove').size() === 1 ){
			$('.search-fields').find('.remove').hide();
		}else{
			$('.search-fields').find('.remove').show();
		}
 }


/*
 * Determines schema for the selected data field.
 */
 function setDataSchema ( obj ){ 
 	if( obj.multiselect ){
 		// simple
 		var select = $('<select></select>')
 			.attr('id',"field-search" + obj.selector.replace('#') )
 			.addClass('multiple-select-'+ obj.key +' select-fields mbase-search-container')
 			.attr('multiple',"multiple")
 			;
 		if( field_schemas[ obj.key ] === undefined ){
 			alert('empty_'+obj.key)
 			
 		// init tags	
 		}else if( obj.key === 'tags'){ 
 			for(var group in field_schemas[ obj.key ]){
				if( field_schemas[ obj.key ].hasOwnProperty(group) ){
					var gr = $('<optgroup></optgroup>')
						.attr('label', group)
						.appendTo( select );
						;	
					for(var i = 0; i < field_schemas[ obj.key ][group].length; i++){
						$('<option>')
							.attr('value', field_schemas[ obj.key ][group][i] )
							.text( field_schemas[ obj.key ][group][i] )
							.appendTo( gr )
							;
					}		
				}
			}// end for
			
			$( obj.selector ).html( select );
			$( obj.selector + ' .multiple-select-'+ obj.key ).select2();
			
		// init other multi-select fields	
 		}else{	
	 		for(var i = 0; i < field_schemas[ obj.key ].length; i++){
				$('<option>')
					.attr('value', field_schemas[ obj.key ][i] )
					.text(  field_schemas[ obj.key ][i] )
					.appendTo( select )
					;
			} 
			$( obj.selector ).html( select );
		}	 
  	// activate multi select
  	$( obj.selector + ' .multiple-select-'+ obj.key ).select2();
  	
  	// init default input
 	}else{
 		$( obj.selector ).html( '<input id="fulltext-search" class="select-fields mbase-search-container" type="text">' );
 	}
 }


/*
 * 
 */
 function submitSearch(){
 		//$('#table1').empty();
 		
 		var query = [];
 		// get data field entries 
 		$('.search-field-row').each(function(i, val){ 
 			var operator = $(val).find('.select-operator option:selected').val();
 			var field = $(val).find('.select-field option:selected').data('key');
 			var input = $(val).find('select.select-fields').val();
 			
 			// build query
 			if( field  !== undefined && input !== '' && input !== undefined ){ 
 				var el = {};
 				 
 				if( operator === 'AND' ){ el[ field ] = { $all:  input };	 }
 				if( operator === 'OR' ){  el[ field ] = { $or:  input };	 }
 				if( operator === 'NOT' ){ el[ field ] = { $not: input };	 } 
 				query.push( el );				 				
 			}
 		});
 		//alert( JSON.stringify(query) )
 		// send query
 		$.post('/modules/search', { data: query }, function(data){	
 			
 			showSearchResults( data );
 			$('#table1').bootstrapTable('refresh', {
          data: data
      });
 		});
 }


/*
 * Renders serach results
 */
function showSearchResults( data ){
$('#table1').bootstrapTable({
    //url: '/data/json/modules',
    data : data,
    onLoadError : function(e){ alert(JSON.stringify(e)); },
    //    onLoadSuccess : function(e){ alert(JSON.stringify(e)); },
    //height:'500',
    showColumns : true,
    checkboxHeader : true,
   // cardView:true, // mobile view
    showExport:true,
    exportDataType:'selected',
    exportOptions: {
    	consoleLog: false,
			csvEnclosure: '"',
			csvSeparator: ',',
			csvUseBOM: true,
			displayTableName: false,
			escape: false,
			excelstyles: [ 'css','properties','to','export','to','excel' ],
			fileName: 'tableExport',
			htmlContent: false,
			ignoreColumn: [],
			ignoreRow: [],
			onCellData: null,
			outputMode: 'file',
			tbodySelector: 'tr',
			theadSelector: 'tr',
			tableName: 'myTableName',
			type: 'csv',
			worksheetName: 'xlsWorksheetName'
    },
    // search
    search: true,
    strictSearch: true,
    trimOnSearch:true,
    
    // details
    detailView : true,
    detailFormatter : function(index, row) {
			return '<a href="/modules/view/' + row._id + '">Detailansicht</a> | <a href="/data/pdf/' + row._id + '">Modulbeschreibung (PDF)</a> | <a href="/modules/edit/' + row._id + '">bearbeiten</a>'//''+index+'__'+row._id;
		},
		//onClickRow : function(row, el){ alert(row._id); },
    onClickCell : function(field, value, row, el){ if(field==='modultitel'){ 
    	alert(row._id);
    } },
    columns: [
		  { field: 'modultitel', title: 'Modulbezeichnung', sortable : true, order: 'asc',searchable : true }, 
		 	{ field: 'modulnr1', title: 'Modulnummer', visible:false, sortable : true, order: 'asc',searchable : true }, 
		  { field: 'modulnr2', title: 'Modulnummer 2', visible:false, sortable : true, order: 'asc',searchable : true }, 
		  { field: 'modulnr3', title: 'Modulnummer 3', visible:false, sortable : true, order: 'asc',searchable : true }, 
		  { field: 'courses', title: 'Studiengang',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'type', title: 'BA/MA',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'university', title: 'Hochschule',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'language', title: 'Sprache',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'sws_total', title: 'SWS',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'workload', title: 'Workload',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'workload_self', title: 'Workload Selbst',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'ects', title: 'ECTS',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'summer_winter', title: 'Semester',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'modulverantwortlicher', title: 'Modulverantwortliche/r',sortable : true, order: 'asc',searchable : true }, 
		  { field: 'mail', title: 'E-Mail',sortable : true, visible:false, order: 'asc',searchable : true }, 
		  { field: 'lecturers', title: 'Weitere Dozenten',sortable : true, visible:false, order: 'asc',searchable : true }, 
		  { field: 'remarks', title: 'Hinweise',sortable : true, order: 'asc',visible:false, searchable : true }, 
		  { field: 'updated_at', title: 'Letzte Änderung',sortable : true, visible:false, order: 'asc',searchable : true }
    ]
	});
}

</script>


