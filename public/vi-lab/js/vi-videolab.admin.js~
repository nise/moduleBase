/** class Vi-LabAdmin **/

var $ = jQuery;
var ViLabAdmin = $.inherit({

  	__constructor : function(wp_url) { 
  		var _this = this;
  		var popcorn_url = wp_url + '/wp-content/plugins/vi-lab/js/popcorn-maker/index.html';
			$("#dialog").hide(); 
			
			// create new popcorn annotations
			$('a#create-annotation').click(function(e){ 
				var frame = $('<iframe></iframe>')	
					.attr('src', popcorn_url + '?video_url=' + $(this).attr('ref') + '&title=' + $(this).attr('title'))
					.attr('height', '600')
					.attr('width', '100%');
					
	
				$("#dialog").html(frame).dialog({
					height: '650', 
					width: '1000', 
					modal:true, 
					draggable: false,
					closeOnEscape: true,
					resizable: false,
					title: $(this).attr('title'),
					position:['100',0], 
					colseText:'x',
					zIndex:200000
				});	
			});
			
			// edit existing annotations
			$('a#edit-annotation').click(function(e){  
				var frame = $('<iframe></iframe>')	
					.attr('src', popcorn_url + '?post_id=' + String($(this).attr('class')).replace('post-',''))
					.attr('height', '100%')
					.attr('width', '100%'); 
	
				$("#dialog").html(frame).dialog({
			height: '650', 
					width: '1000', 
					modal:true, 
					draggable: false,
					closeOnEscape: true,
					resizable: false,
					title: $(this).attr('title'),
					position:['100',0], 
					zIndex:200000
				});	
			});
			
			this.buildWidgetEditor();
	},
	
	// static hack, information should be aquired from vi2.main
	widgets : {
		status: 'ok', 
		widgets: [
			{name: 'toc'},
			{name: 'tags'}, 
			{name: 'xlink'},
			{name: 'comments'},
			{name: 'slides'}, 
			{name: 'assessment'}
		],
		i:0,
		instructions : [
			{title: 'willkommen', content: 'blas', sel:0},
			{title: 'ommen', content: 'corlortes', sel:1},
			{title: 'Öffnung', content: 'corlortes', sel:1},
			{title: 'Öffnung', content: 'corlortes', sel:1}
		]
	},

		
	/*  .. */
	buildWidgetEditor : function(widgets){		
		var _this = this;
		// build table
		$('.widget-form-table').setTemplate($('#widget-editor-tpl').val()).processTemplate(this.widgets);
		$('.script-form-table').setTemplate($('#script-editor-tpl').html()).processTemplate(this.widgets);
		
		
		// set table values via ajax call
		var data = { action: 'get_widget_options' };
		// call
		$.post(ajaxurl, data, function(res) {
			res = JSON.parse(res.split('!!!!')[1]);
			
			$.each(_this.widgets.widgets, function(i, widget){ 
				$('input#widget-'+widget.name).attr('checked', res[widget.name+'_enabled'] ? 'checked' : false);
				$('input#widget-'+widget.name+'-app-panel1').attr('checked', res[widget.name+'_app_panel1'] ? 'checked' : false);
				$('input#widget-'+widget.name+'-app-panel2').attr('checked', res[widget.name+'_app_panel2'] ? 'checked' : false);
			 	$('input#widget-'+widget.name+'-app-accordion').attr('checked', res[widget.name+'_app_accordion'] ? 'checked' : false);
				$('input#widget-'+widget.name+'-app-timeline').attr('checked', res[widget.name+'_app_timeline'] ? 'checked' : false);
				$('input#widget-'+widget.name+'-ann-popcorn').attr('checked', res[widget.name+'_ann_popcorn'] ? 'checked' : false);
				$('input#widget-'+widget.name+'-ann-player').attr('checked', res[widget.name+'_ann_player'] ? 'checked' : false);
			});	//$('.widget-form-table').find('#'+widget.name+'-row').addClass('inactive');
			
			var ii = 1;
			$.each(res, function(i, ins){ 
				if(i.substr(0,18) == 'instruction_title_'){   
					$('#instruction'+ii).val(res['instruction_'+ii]);
					$('#instructiontitle'+ii).attr('value',res['instruction_title_'+ii]); 
					if(res['current_phase'] == ii){ 
						$('#instructioncurrent'+(ii-1)).attr('checked',true); // strange hack
					}else{
						//$('#instructioncurrent'+ii).attr('checked',false);
					}
					ii++;
				}
			});
				
		});	
	}
		
	

});// end class
